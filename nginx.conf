upstream fastapi {
    server web:8000;
}

upstream jitsi {
    server jitsi-web:80;
}

server {
    listen 80;
    server_name localhost;

    client_max_body_size 20M;

    location = /static/recommendedBrowsers.html {
        return 204;
        add_header Content-Type text/html;
    }

    location ~ ^/(css|libs|images|fonts|lang|sounds|static|manifest\.json|favicon\.ico|robots\.txt|_api|xmpp|colibri|http-bind|about) {
        proxy_pass http://jitsi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header User-Agent $http_user_agent;
        proxy_redirect off;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    location /meets {
        rewrite ^/meets/(.*) /$1 break;
        rewrite ^/meets$ / break;
        proxy_pass http://jitsi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header User-Agent $http_user_agent;
        proxy_redirect off;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        
        sub_filter '</head>' '<script>(function(){function hideWarning(){try{const selectors=["#recommendedBrowsers",".recommended-browsers","[data-testid=\"recommendedBrowsers\"]","iframe[src*=\"recommendedBrowsers\"]",".browser-warning",".unsupported-browser"];selectors.forEach(s=>{try{document.querySelectorAll(s).forEach(e=>{e.style.display="none";e.style.visibility="hidden";e.remove()})}catch(e){}});document.querySelectorAll("iframe").forEach(i=>{try{if(i.src&&i.src.includes("recommendedBrowsers")){i.style.display="none";i.remove()}}catch(e){}});const body=document.body;if(body){const divs=body.querySelectorAll("div");divs.forEach(d=>{try{if(d.textContent&&(d.textContent.includes("browser we don")||d.textContent.includes("Chrome or Chromium"))){d.style.display="none";d.remove()}}catch(e){}})}}catch(e){}}hideWarning();if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",hideWarning)}else{hideWarning()}setTimeout(hideWarning,50);setTimeout(hideWarning,100);setTimeout(hideWarning,300);setTimeout(hideWarning,500);setTimeout(hideWarning,1000);setTimeout(hideWarning,2000);try{new MutationObserver(hideWarning).observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0})}catch(e){}})();</script></head>';
        sub_filter_once off;
        sub_filter_types text/html;
    }

    location / {
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

