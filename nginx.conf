upstream fastapi {
    server web:8000;
}

upstream jitsi {
    server jitsi-web:80;
}

server {
    listen 80;
    server_name localhost;

    client_max_body_size 20M;

    location ~ ^/(css|libs|images|fonts|lang|sounds|static|manifest\.json|favicon\.ico|robots\.txt|_api|xmpp|colibri|http-bind|about) {
        proxy_pass http://jitsi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header User-Agent $http_user_agent;
        proxy_redirect off;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    location /meets {
        rewrite ^/meets/(.*) /$1 break;
        rewrite ^/meets$ / break;
        proxy_pass http://jitsi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header User-Agent $http_user_agent;
        proxy_redirect off;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        
        sub_filter '</head>' '<script>(function(){const ua=navigator.userAgent;Object.defineProperty(navigator,"userAgent",{get:function(){return ua.replace(/Chrome\/\d+\.\d+\.\d+\.\d+/,"Chrome/120.0.0.0")}});function overrideBrowserCheck(){try{const hideWarning=function(){try{const warning=document.querySelector("#recommendedBrowsers")||document.querySelector(".recommended-browsers")||document.querySelector("[data-testid=\"recommendedBrowsers\"]")||document.querySelector("iframe[src*=\"recommendedBrowsers\"]");if(warning){warning.style.display="none";warning.style.visibility="hidden";warning.remove();return!0}return!1}catch(e){return!1}};if(hideWarning()){return}if(window.JitsiMeetJS){if(window.JitsiMeetJS.util&&window.JitsiMeetJS.util.browser){const orig=window.JitsiMeetJS.util.browser;window.JitsiMeetJS.util.browser=function(){const r=orig.apply(this,arguments);if(!r||r.name==="Unsupported"||r.name==="Other"){return{name:"Chrome",version:"120",supportsWebRTC:!0,isSupported:!0}}return r}}if(window.JitsiMeetJS.util&&window.JitsiMeetJS.util.BrowserDetection){window.JitsiMeetJS.util.BrowserDetection={isChrome:function(){return!0},isFirefox:function(){return!1},isSafari:function(){return!1},isOpera:function(){return!1},isEdge:function(){return!1},isIE:function(){return!1},getBrowserName:function(){return"Chrome"},getBrowserVersion:function(){return"120"}}}}if(window.APP){if(window.APP.conference){window.APP.conference.isSupportedBrowser=function(){return!0}}if(window.APP.util){window.APP.util.browser={name:"Chrome",version:"120",supportsWebRTC:!0}}}}if(window.config){window.config.disableBrowserWarning=!0;window.config.disableDeepLinking=!1}hideWarning();setTimeout(hideWarning,50);setTimeout(hideWarning,100);setTimeout(hideWarning,200);setTimeout(hideWarning,500);setTimeout(hideWarning,1000);try{new MutationObserver(function(){hideWarning()}).observe(document.body||document.documentElement,{childList:!0,subtree:!0,attributes:!0})}catch(e){}}catch(e){}}overrideBrowserCheck();if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",overrideBrowserCheck)}else{overrideBrowserCheck()};setInterval(overrideBrowserCheck,1000)})();</script></head>';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    location / {
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

