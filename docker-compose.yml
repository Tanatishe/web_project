services:
  web:
    build: .
    environment:
      - DEBUG=false
    volumes:
      - .:/app
      - venv:/app/.venv
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "10000:10000/udp"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web
      - jitsi-web
    networks:
      - app-network

  jitsi-web:
    image: jitsi/web:stable
    restart: unless-stopped
    volumes:
      - jitsi-web-config:/config:Z
    environment:
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - ENABLE_LETSENCRYPT=0
      - DISABLE_HTTPS=1
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_BOSH_URL_BASE=http://jitsi-prosody:5280
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - ETHERPAD_URL_BASE=http://jitsi-etherpad:9001
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=10000
      - TRUST_PROXY=true
    networks:
      - app-network

  jitsi-prosody:
    image: jitsi/prosody:stable
    restart: unless-stopped
    volumes:
      - jitsi-prosody-config:/config:Z
    environment:
      - AUTH_TYPE=internal
      - ENABLE_AUTH=0
      - ENABLE_GUESTS=1
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_GUEST_DOMAIN=guest.meet.jitsi
      - XMPP_MUC_DOMAIN=muc.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=focuspass
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=jvbpass
    networks:
      - app-network

  jitsi-jvb:
    image: jitsi/jvb:stable
    restart: unless-stopped
    volumes:
      - jitsi-jvb-config:/config:Z
    environment:
      - DOCKER_HOST_ADDRESS=
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=jitsi-prosody
      - JVB_AUTH_USER=jvb
      - JVB_AUTH_PASSWORD=jvbpass
      - JVB_BREWERY_MUC=jvbbrewery
      - JVB_PORT=10000
    networks:
      - app-network

  jitsi-jicofo:
    image: jitsi/jicofo:stable
    restart: unless-stopped
    volumes:
      - jitsi-jicofo-config:/config:Z
    environment:
      - ENABLE_AUTH=0
      - XMPP_DOMAIN=meet.jitsi
      - XMPP_AUTH_DOMAIN=auth.meet.jitsi
      - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
      - XMPP_SERVER=jitsi-prosody
      - JICOFO_AUTH_USER=focus
      - JICOFO_AUTH_PASSWORD=focuspass
    networks:
      - app-network

  jitsi-etherpad:
    image: etherpad/etherpad:latest
    restart: unless-stopped
    environment:
      - ADMIN_PASSWORD=admin
      - TRUST_PROXY=true
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  venv:
  jitsi-web-config:
  jitsi-prosody-config:
  jitsi-jvb-config:
  jitsi-jicofo-config:

